SELECT SETOR, VALOR
FROM (SELECT VALOR_LANCADO.NM_SETOR SETOR, SUM(VALOR_LANCADO.VL_TOTAL_CONTA) VALOR
FROM (
 SELECT 
 --GRU_FAT.DS_GRU_FAT, 
 --PRO_FAT.DS_PRO_FAT, 
 --ITREG_AMB.VL_UNITARIO, 
 --ITREG_AMB.VL_HONORARIO_UNITARIO, 
 --ITREG_AMB.VL_OPERACIONAL_UNITARIO, 
 --CONVENIO.NM_CONVENIO,
 NVL(ITREG_AMB.VL_TOTAL_CONTA,0) VL_TOTAL_CONTA,
 --ITREG_AMB.SN_FECHADA, 
 SETOR.NM_SETOR
 --REG_AMB.* 
 
 FROM REG_AMB REG_AMB
 INNER JOIN ITREG_AMB ON ITREG_AMB.CD_REG_AMB = REG_AMB.CD_REG_AMB
 INNER JOIN ATENDIME ON ATENDIME.CD_ATENDIMENTO = ITREG_AMB.CD_ATENDIMENTO
 INNER JOIN CONVENIO ON CONVENIO.CD_CONVENIO = ITREG_AMB.CD_CONVENIO
 INNER JOIN GRU_FAT ON GRU_FAT.CD_GRU_FAT = ITREG_AMB.CD_GRU_FAT
 INNER JOIN PRO_FAT ON PRO_FAT.CD_PRO_FAT = ITREG_AMB.CD_PRO_FAT
 INNER JOIN SETOR ON SETOR.CD_SETOR = ITREG_AMB.CD_SETOR
 INNER JOIN REMESSA_FATURA ON REMESSA_FATURA.CD_REMESSA = REG_AMB.CD_REMESSA
 INNER JOIN FATURA ON FATURA.CD_FATURA = REMESSA_FATURA.CD_FATURA
 
 WHERE TO_CHAR(FATURA.DT_COMPETENCIA, 'MM/YYYY') = '07/2018'
 AND ITREG_AMB.SN_PERTENCE_PACOTE = 'N'
 AND ITREG_AMB.SN_FECHADA = 'S'
 AND NVL(ITREG_AMB.TP_PAGAMENTO, 'X') <> 'C'
 AND NVL(REG_AMB.SN_DIAGNO, 'N') = 'N'
 AND CONVENIO.TP_CONVENIO NOT IN ('H', 'A')
 AND REMESSA_FATURA.SN_FECHADA = 'S'
 AND REG_AMB.CD_MULTI_EMPRESA = 1
 
UNION ALL

SELECT 
--GRU_FAT.DS_GRU_FAT, 
--PRO_FAT.DS_PRO_FAT, 
--ITREG_AMB.VL_UNITARIO, 
--ITREG_AMB.VL_HONORARIO_UNITARIO, 
--ITREG_AMB.VL_OPERACIONAL_UNITARIO, 
--CONVENIO.NM_CONVENIO,
NVL(ITREG_FAT.VL_TOTAL_CONTA,0) VL_TOTAL_CONTA,
--ITREG_AMB.SN_FECHADA, 
SETOR.NM_SETOR
--REG_AMB.* 

FROM REG_FAT REG_FAT
INNER JOIN ITREG_FAT ON ITREG_FAT.CD_REG_FAT = REG_FAT.CD_REG_FAT
INNER JOIN CONVENIO ON CONVENIO.CD_CONVENIO = REG_FAT.CD_CONVENIO
INNER JOIN ATENDIME ON ATENDIME.CD_ATENDIMENTO = REG_FAT.CD_ATENDIMENTO
INNER JOIN GRU_FAT ON GRU_FAT.CD_GRU_FAT = ITREG_FAT.CD_GRU_FAT
INNER JOIN PRO_FAT ON PRO_FAT.CD_PRO_FAT = ITREG_FAT.CD_PRO_FAT
INNER JOIN SETOR ON SETOR.CD_SETOR = ITREG_FAT.CD_SETOR
INNER JOIN REMESSA_FATURA ON REMESSA_FATURA.CD_REMESSA = REG_FAT.CD_REMESSA
INNER JOIN FATURA ON FATURA.CD_FATURA = REMESSA_FATURA.CD_FATURA

WHERE 
TO_CHAR(FATURA.DT_COMPETENCIA, 'MM/YYYY') = '07/2018' 
AND ITREG_FAT.SN_PERTENCE_PACOTE = 'N'
AND NVL(ITREG_FAT.TP_PAGAMENTO, 'X') <> 'C'
AND NVL(REG_FAT.SN_DIAGNO, 'N') = 'N'
--AND ITREG_FAT.DT_LANCAMENTO BETWEEN To_Date('01/05/2017','dd/MM/yyyy') AND TO_DATE('31/05/2017' , 'dd/mm/yyyy') + .99999
AND CONVENIO.TP_CONVENIO NOT IN ('H', 'A')
AND REG_FAT.SN_FECHADA = 'S'
AND REMESSA_FATURA.SN_FECHADA = 'S'
AND REG_FAT.CD_MULTI_EMPRESA = 1) VALOR_LANCADO

GROUP BY VALOR_LANCADO.NM_SETOR
ORDER BY VALOR_LANCADO.NM_SETOR
)
GROUP BY SETOR, VALOR
ORDER BY VALOR DESC
